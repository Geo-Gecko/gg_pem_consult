<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="description" content="PEM projects Map from Geo Gecko ." />

  <title>PEM map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" />


  <!--   <link rel="stylesheet" href="css/normalize.css" /> -->

  <link rel="stylesheet" href="css/PEM.css" />


  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.js"></script>
  <script src="src/skeleton-tabs.js"></script>
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/11.1.0/nouislider.min.css" /> -->

  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <!-- <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script> -->
  <!-- Color Scale -->
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

  <style>
    .selected {
      background-color: #aac741;
    }
  </style>
</head>

<body>

  <div id="container">
    <div id="mapRegions"></div>
    <div id="map"></div>
    <div id="controlPanel" class="control-panel">
      <br>
      <ul class="tab-nav">
        <li>
          <a class="button active" href="#Filters" style="width: 48%;">Filters</a>
        </li>
        <li>
          <a class="button" href="#Projects" id="projectsButton" style="width: 48%;">Projects <span
              id="pem-count"></span> <span id="summary"></span></a>
        </li>
      </ul>


      <div class="tab-content" style="overflow-y: auto; height:80%; margin: auto;" class="filterclass">


        <!-- FILTER TAB-->
        <div class="tab-pane active" id="Filters">
          <center>
            <div class="row" id="test">
              <div>
                <button class="w3-bar-item w3-button w3-mobile" style="font-size: 10px; float: center !important;"
                  id="countries">Countries</button>
                <br>
                <button class="w3-bar-item w3-button w3-mobile" style="font-size: 10px; float: center !important;"
                  id="regions">Regions</button>
              </div>
              <br>
              <div>
                <strong>People</strong>
                <!-- <button class="sector w3-bar-item w3-button" title="Agricultural & Rural Development" style="font-size: 5px; float: center !important;" id="clearPeople">Clear</button> -->
                <br>
                <button class="sector w3-bar-item w3-button w3-mobile" title="Governance & Civil Society"
                  style="font-size: 10px; float: center !important;">GCS</button>
                <button class="sector w3-bar-item w3-button w3-mobile" title="Skills & Employment"
                  style="font-size: 10px; float: center !important;">SE</button>
                <button class="sector w3-bar-item w3-button w3-mobile" title="Growth & Market Development"
                  style="font-size: 10px; float: center !important;">GMD</button>
                <button class="sector w3-bar-item w3-button w3-mobile" title="Agricultural & Rural Development"
                  style="font-size: 10px; float: center !important;">ARD</button></div>
              <div>
                <strong>Environment</strong>
                <!-- <button class="sector w3-bar-item w3-button" title="Agricultural & Rural Development" style="font-size: 5px; float: center !important;" id="clearEnvironment">Clear</button> -->
                <br>
                <button class="sector w3-bar-item w3-button" title="Water & Sanitation"
                  style="font-size: 10px; float: center !important;">WS</button>
                <button class="sector w3-bar-item w3-button" title="Environmental & Natural Resource Management"
                  style="font-size: 10px; float: center !important;">ENM</button>
                <button class="sector w3-bar-item w3-button" title="Renewable Energy"
                  style="font-size: 10px; float: center !important;">RE</button>
                <button class="sector w3-bar-item w3-button" title="Climate Change"
                  style="font-size: 10px; float: center !important;">CC</button>
              </div>
              <div>
                <strong>Management</strong>
                <!-- <button class="sector w3-bar-item w3-button" title="Agricultural & Rural Development" style="font-size: 5px; float: center !important;" id="clearManagement">Clear</button> -->
                <br>
                <button class="sector w3-bar-item w3-button" title="Financial Management"
                  style="font-size: 10px; float: center !important;">FM</button>
                <button class="sector w3-bar-item w3-button" title="Public Sector Management & Reform"
                  style="font-size: 10px; float: center !important;">PSM</button>
                <button class="sector w3-bar-item w3-button" title="Sector Planning"
                  style="font-size: 10px; float: center !important;">SP</button>
                <button class="sector w3-bar-item w3-button" title="Aid Management & Result Based Management"
                  style="font-size: 10px; float: center !important;">AM</button>
              </div>
              <div>
                <button class="w3-bar-item w3-button" style="font-size: 10px; float: center !important;"
                  id="resetSliders">Reset Sliders</button>
              </div>
            </div>

            <!--List of filters:  -->
            <div id='sliderContainer' style="float:unset; overflow-y: auto; max-height: 100%;">
              <div>
                <div class="col-md-" style="overflow-x: hidden">
                  <center>
                    <div id="pem-filter-list" class="row_sliders"></div>
                  </center>
                </div>
              </div>
            </div>
          </center>
        </div>

        <script>
          $(window).on('resize', function () {
            if ($(window).width() > 850) {
              $('#test').addClass('row');
              $('#test').removeClass('row2');
            } else {
              $('#test').addClass('row2');
              $('#test').removeClass('row');
            }
          })
        </script>
        <script>
          $(window).on('resize', function () {
            if ($(window).width() > 850) {
              $('#pem-filter-list').addClass('row_sliders');
              $('#pem-filter-list').removeClass('row_sliders2');
            } else {
              $('#pem-filter-list').addClass('row_sliders2');
              $('#pem-filter-list').removeClass('row_sliders');
            }
          })
        </script>



        <!-- Projects tab -->
        <div class="tab-pane" class="filterclass" id="Projects"
          style="overflow-x: hidden;height: 100%;width: 90% !important;">
          <!-- numbers -->
          <div class="container">
            <div class="head">
              <strong>Filtered projects</strong>
              <div id='headers'></div>
              <!-- <table> -->
              <!-- <tbody>
                  <tr style="width: 100% !important;" >
                    <td class="header" style="width: 25%;">Start Year</th>
                    <td class="header" style="width: 25%;">Duration</th>
                    <td class="header" style="width: 25%;">PROJECT TITLE</th>
                    <td class="header" style="width: 25%;">COUNTRY</th>
                    <td class="header" style="width: 25%;">Name of Client</th>
                    <td class="header" style="width: 25%;">EUR Value of assignment</th>
                  </tr>
                </tbody> -->
              <!-- </table> -->
            </div>
            <div class="content">
              <div id="projectsTable"></div>
            </div>
            <div class="foot"></div>
          </div>

        </div>
      </div>

    </div>

  </div>
  </div>


  <script>
    function eventFire(el, etype) {
      if (el.fireEvent) {
        el.fireEvent('on' + etype);
      } else {
        var evObj = document.createEvent('Events');
        evObj.initEvent(etype, true, false);
        el.dispatchEvent(evObj);
      }
    }

    function openPanel(PanelName) {
      var i;
      var x = document.getElementsByClassName("filterclass");
      for (i = 0; i < x.length; i++) {
        x[i].style.display = "none";
      }
      document.getElementById(PanelName).style.display = "block";
    }

    function updateTable(data, element, different) {

      d3.select(element).select('table').remove();
      var sortAscending = true;
      var table = d3.select(element).append('table');
      var titles = d3.keys(data[0]);
      var titlesText = ["Start Year", "Duration", "PROJECT TITLE", "COUNTRY", "Name of Client", "EUR Value of assignment"]
      var headers = table.append('thead').append('tr')
        .attr('id', 'headersT')
        .selectAll('th')
        .data(titlesText).enter()
        .append('th')
        .style('width', '25%')
        .text(function (d) {
          return d
        })
        .on('click', function (d) {
          console.log(d)
          headers.attr('class', 'header');
          if (sortAscending) {
            rows.sort(function (a, b) {
              return d3.descending(a.key, b.key)
            });
            sortAscending = false;
            this.className = 'aes';
          } else {
            rows.sort(function (a, b) {
              return d3.ascending(a.key, b.key)
            });
          }

        });
      // $('#headers').prepend($('#headersT'));

      // console.log(headers)
      var rows = table.append('tbody').selectAll('tr')
        .data(data).enter()
        .append('tr');
      rows.selectAll('td')
        .data(function (d) {
          return titlesText.map(function (k) {
            //  console.log(d + " | " + k)
            if (k === 'values') {
              return {
                'value': +(d[k].length),
                'name': k
              };
            } else {
              return {
                'value': d[k],
                'name': k
              };
            }

          });
        }).enter()
        .append('td')
        .style('width', '25%')
        .attr('data-th', function (d) {
          return d.name;
        })
        .attr('class', function (d) {
          if (d.value === different) {
            return 'highlighted'
          }
          return
        })
        .text(function (d) {
          // console.log(typeof(d.value))
          if (typeof (d.value) === 'string') {
            return d.value.replace(/[^\x00-\x7F]/g, "");
          } else return d.value;
        })

      $('.highlighted').parent().animate({ backgroundColor: '#aac741' }, 1000).animate({ borderColor: '#C97200' }, 1000);

      var highlight = d3.selectAll('.highlighted');
      $.each(highlight._groups[0], function (index, value) {
        value.parentElement.style.backgroundColor = "#aac741";
      });

    }
  </script>


  <!-- first load LeafletJS -->
  <script src="https://unpkg.com/leaflet@1.3/dist/leaflet.js"></script>

  <!-- also load 3rd-party CSV parsing libary just for this demo  -->
  <script src="https://unpkg.com/papaparse@4.3/papaparse.min.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>


  <script src="src/piechartAndLegend.js"></script>
    
  <script src="src/countries.js"></script>

  <script src="src/regions.js"></script>

  <script>
    var globalDataset, filteredDataset, filteredCountryList, filteredRegionList, sliderData = [{
      key: "EUR Value of assignment",
      values: []
    }, {
      key: "Start Year",
      values: []
    }
    ];

    $('.sector').on('click', function (e) {
      $(this).toggleClass("selected unselected"); //you can list several class names 
      styleFeatures(sliderData);
      e.preventDefault();
    });
  </script>


  <script>
    function styleFeatures(sliderData) {

      // console.log(sliderData)

      $('#summary').hide();
      var selected = d3.selectAll('.selected');

      var activeButtons = [];
      var _filteredDataset = []

      if (selected._groups[0].length > 0) {
        $.each(selected._groups[0], function (index, value) {
          activeButtons.push(value.textContent);
        });

        _filteredDataset = globalDataset.filter(function (k) {
          const found = [k.KW1, k.KW2].some(r => activeButtons.includes(r))
          if (found) {
            return k;
          }
        })

      } else {

        activeButtons = [];
        _filteredDataset = globalDataset

      }


      var _filtered1 = [];
      var _filtered = [];


      _filteredDataset.filter(function (k) {
        $.each(sliderData, function (index, value) {
          if (value.key !== "Start Year") {
            if (parseFloat(k[value.key].toString().replace(/,/g, '')) >= parseFloat(value.values[0]) && parseFloat(k[value.key].toString().replace(/,/g, '')) <= parseFloat(value.values[1])) {
              _filtered1.push(k);
              return k;
            }
          }
        })
      })

      _filtered1.filter(function (k) {
        $.each(sliderData, function (index, value) {
          if (value.key === "Start Year") {
            if (parseFloat(Date.parse(k[value.key].toString())) >= parseFloat(Date.parse(value.values[0].toString())) && parseFloat(Date.parse(k[value.key].toString())) <= parseFloat(Date.parse(value.values[1].toString()))) {
              _filtered.push(k)
              return k;
            }
          }
        })
      })

      filteredDataset = _filtered;

      var _countryList = d3.nest().key(function (d) {
        return d.COUNTRY;
      }).sortKeys(d3.ascending).entries(_filtered);

      filteredCountryList = _countryList;

      var _regionList = d3.nest().key(function (d) {
        return d.REGION;
      }).sortKeys(d3.ascending).entries(_filtered);

      filteredRegionList = _regionList;

      var maxCountry = d3.max(_countryList, function (d) {
        return d.values.length;
      })

      var maxRegion = d3.max(_regionList, function (d) {
        return d.values.length;
      })

      d3.select("#pem-count").text(numberWithCommas(_filtered.length));



      var _sortedData = _filtered.sort(function (a, b) {
        return d3.ascending(a.COUNTRY, b.COUNTRY)
      })

      updateTable(_sortedData, '#projectsTable');

      featureElement.style("fill", function (d) {
        d.properties._projectCount = -1;
        d.properties._projectValue = -1
        _countryList.map(function (c) {
          if (c.key === d.properties.NAME) {
            d.properties._projectCount = c.values.length;
            d.properties._projectValue = d3.sum(c.values, function (d) {
              return parseFloat(d["EUR Value of assignment"].toString().replace(/,/g, ''))
            })
          }
        });

        return d.properties._projectCount > (Math.ceil(maxCountry / 4) * 3) ? '#006d2c' :
          d.properties._projectCount > (Math.ceil(maxCountry / 4) * 2) ? '#41ab5d' :
            d.properties._projectCount > (Math.ceil(maxCountry / 4)) ? '#74c476' :
              d.properties._projectCount > 0 ? '#a1d99b' :
                '#fff';

      })

      var array = ['#fff', '#a1d99b', '#74c476', '#41ab5d', '#006d2c'];
      var arrayLabel = ["No Projects", "0 - " + (Math.ceil(maxCountry / 4)), (Math.ceil(maxCountry / 4)) + " - " + (Math.ceil(maxCountry / 4) * 2), (Math.ceil(maxCountry / 4) * 2) + " - " + (Math.ceil(maxCountry / 4) * 3), (Math.ceil(maxCountry / 4) * 3) + " - " + (Math.ceil(maxCountry / 4) * 4)];

      addLegend(array, arrayLabel, "Legend", "#legend", "circle");

      featureElementRegions.style("fill", function (d) {
        d.properties._projectCount = -1;
        d.properties._projectValue = -1
        _regionList.map(function (c) {
          if (c.key === d.properties.REGION_UN) {
            d.properties._projectCount = c.values.length;
            d.properties._projectValue = d3.sum(c.values, function (d) {
              return parseFloat(d["EUR Value of assignment"].toString().replace(/,/g, ''))
            })
          }
        });


        return d.properties._projectCount > (Math.ceil(maxRegion / 4) * 3) ? '#006d2c' :
          d.properties._projectCount > (Math.ceil(maxRegion / 4) * 2) ? '#41ab5d' :
            d.properties._projectCount > (Math.ceil(maxRegion / 4)) ? '#74c476' :
              d.properties._projectCount > 0 ? '#a1d99b' :
                '#fff';

      })

      var array = ['#fff', '#a1d99b', '#74c476', '#41ab5d', '#006d2c'];
      var arrayLabel = ["No Projects", "0 - " + (Math.ceil(maxRegion / 4)), (Math.ceil(maxRegion / 4)) + " - " + (Math.ceil(maxRegion / 4) * 2), (Math.ceil(maxRegion / 4) * 2) + " - " + (Math.ceil(maxRegion / 4) * 3), (Math.ceil(maxRegion / 4) * 3) + " - " + (Math.ceil(maxRegion / 4) * 4)];

      addLegend(array, arrayLabel, "Legend", "#legendRegion", "circle");
    }

    function numberWithCommas(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    //tooltip code
    var infobulle = d3.select("body")
      .append("div")
      .style("position", "absolute")
      .style("background", "white")
      .style("opacity", "0")
      .style("padding", "0 10px")
      .style("z-index", "999")
      .style("pointer-events", "none")

    var map;
    var mapRegion;

    // map.fitBounds(bounds);
    Papa.parse('PEM_data/PEM Reference database June 2019.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function (results) {

        Papa.parse('PEM_data/sliders.csv', {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: function (results) {
            forMax = results.data;
            filters(results);
          }
        });

        globalDataset = results.data;

        filteredDataset = results.data;

        //D3 function to summarize table by country
        var countryList = d3.nest().key(function (d) {
          return d.COUNTRY;
        }).sortKeys(d3.ascending).entries(results.data);

        filteredCountryList = countryList

        //D3 function to summarize table by region
        var regionList = d3.nest().key(function (d) {
          return d.REGION
        }).sortKeys(d3.ascending).entries(results.data);

        filteredRegionList = regionList;

        d3.select("#pem-count").text(numberWithCommas(results.data.length));

        var _maxCountry = d3.max(countryList, function (d) {
          return d.values.length;
        })

        var _maxRegion = d3.max(regionList, function (d) {
          return d.values.length;
        })

        var sortedData = results.data.sort(function (a, b) {
          return d3.ascending(a.COUNTRY, b.COUNTRY)
        })

        updateTable(sortedData, '#projectsTable');

        var domain = [+Infinity, -Infinity];

        main(countriesGeoJson);
        mainRegion(regionsGeoJson);

        function main(data) {
          addLmaps();
          drawFeatures(data);
        }

        function mainRegion(data) {
          addLmapsRegions();
          drawFeaturesRegions(data);
        }

        function addLmaps() {

          map = L.map('map', {
            zoomSnap: 0.25
          });
          if (L.Browser.mobile) {
            map.setView([29.855533, 48.147778], 1.5);
          } else {
            map.setView([29.855533, 48.147778], 1.5);
          }

          var southWest = new L.LatLng(-62.406149313445724, -371.06284625024193),
            northEast = new L.LatLng(84.35856680726017, 431.65195637659485),
            bounds = new L.LatLngBounds(southWest, northEast);

          map.fitBounds(bounds);

          L.svg().addTo(map);

          var Legend = L.control({ position: 'bottomright' });

          Legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML +=
              '<div id="legend"></div>';
            return div;
          };

          Legend.addTo(map);

        }

        function addLmapsRegions() {

          mapRegions = L.map('mapRegions', {
            zoomSnap: 0.25
          });
          if (L.Browser.mobile) {
            mapRegions.setView([29.855533, 48.147778], 1.5);
          } else {
            mapRegions.setView([29.855533, 48.147778], 1.5);
          }

          var southWest = new L.LatLng(-62.406149313445724, -371.06284625024193),
            northEast = new L.LatLng(84.35856680726017, 431.65195637659485),
            bounds = new L.LatLngBounds(southWest, northEast);

          mapRegions.fitBounds(bounds);

          L.svg().addTo(mapRegions);

          var legendRegion = L.control({ position: 'bottomleft' });

          legendRegion.onAdd = function (mapRegions) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML +=
              '<div id="legendRegion"></div>';
            return div;
          };

          legendRegion.addTo(mapRegions);

        }

        function projectPoint(x, y) {
          var point = map.latLngToLayerPoint(new L.LatLng(y, x));
          this.stream.point(point.x, point.y);
        }

        function projectPointRegions(x, y) {
          var point = mapRegions.latLngToLayerPoint(new L.LatLng(y, x));
          this.stream.point(point.x, point.y);
        }

        function drawFeatures(data) {
          var svg = d3.select("#map").select("svg");

          var transform = d3.geoTransform({
            point: projectPoint
          });
          var path = d3.geoPath().projection(transform);

          featureElement = svg.selectAll("path")
            .data(data.features)
            .enter()
            .append("path")
            .attr('fill-opacity', '0.5')
            .attr("z-index", "600")
            .attr("style", "pointer-events:all!important")
            .style("cursor", "pointer")
            .each(function (d) {
              countryList.map(function (c) {
                if (c.key === d.properties.NAME) {
                  d.properties._projectCount = c.values.length;
                  d.properties._projectValue = d3.sum(c.values, function (d) {
                    return parseFloat(d["EUR Value of assignment"].toString().replace(/,/g, ''))
                  })
                  var filterValue = +(d.properties._projectCount);
                  domain[0] = filterValue < domain[0] ? filterValue :
                    domain[
                    0];
                  domain[1] = filterValue > domain[1] ? filterValue :
                    domain[
                    1];
                }
              });
            })
            .attr("stroke-width", "0.5px")
            .attr("stroke", "#848383")
            .attr("fill", function (d) {
              return d.properties._projectCount > (Math.ceil(_maxCountry / 4) * 3) ? '#006d2c' :
                d.properties._projectCount > (Math.ceil(_maxCountry / 4) * 2) ? '#41ab5d' :
                  d.properties._projectCount > (Math.ceil(_maxCountry / 4)) ? '#74c476' :
                    d.properties._projectCount > 0 ? '#a1d99b' :
                      '#fff';

            })
            .on("click", function (d) {
              eventFire(document.getElementById('projectsButton'), 'click');

              $('#summary').show();
              $('#summary').html('<span>' + d.properties.NAME + ' (None)</span>');

              $.each(filteredCountryList, function (index, value) {
                if (d.properties.NAME === value.key) {
                  $('#summary').html('<span>' + d.properties.NAME + ' (' + value.values.length + ' projects)</span>');
                }
              })


              var sortedData = filteredDataset.sort(function (a, b) {
                //  console.log(Date.parse(a["Start date (Month/Year)"].toString()))
                return d3.ascending(Date.parse(a["Start Year"].toString()), Date.parse(b["Start Year"].toString()))
              })

              var top = sortedData.filter(function (k) {
                if (k.COUNTRY === d.properties.NAME) {
                  return k;
                }
              })

              var bottom = sortedData.filter(function (k) {
                if (k.COUNTRY !== d.properties.NAME) {
                  return k;
                }
              })

              if (top.concat(bottom)) {
                updateTable(top.concat(bottom), "#projectsTable", d.properties.NAME)
              } else {
                updateTable([], "#projectsTable")
              }

            })
            .on("mouseover", function (d) {

              var text = ''
              $.each(filteredCountryList, function (index, value) {
                if (d.properties.NAME === value.key) {
                  text = '<span>' + d.properties.NAME + ' (' + value.values.length + ' filtered projects)</span>';
                }
              })

              infobulle.transition()
                .style("opacity", .9)
              // console.log(d)
              infobulle.html(text)
                .style("left", (d3.event.pageX - 35 + "px"))
                .style("top", (d3.event.pageY - 30 + "px"))
            })
            .on("mouseout", function (d) {
              infobulle.transition()
                .style("opacity", 0);
            })

          var array = ['#fff', '#a1d99b', '#74c476', '#41ab5d', '#006d2c'];
          var arrayLabel = ["No Projects", "0 - " + (Math.ceil(_maxCountry / 4)), (Math.ceil(_maxCountry / 4)) + " - " + (Math.ceil(_maxCountry / 4) * 2), (Math.ceil(_maxCountry / 4) * 2) + " - " + (Math.ceil(_maxCountry / 4) * 3), (Math.ceil(_maxCountry / 4) * 3) + " - " + (Math.ceil(_maxCountry / 4) * 4)];

          addLegend(array, arrayLabel, "Legend", "#legend", "circle");

          map.on("moveend", update);

          update();

          function update() {
            featureElement.attr("d", path);
          }

        }

        function drawFeaturesRegions(data) {
          var svg = d3.select("#mapRegions").select("svg");

          var transform = d3.geoTransform({
            point: projectPointRegions
          });
          var path = d3.geoPath().projection(transform);

          featureElementRegions = svg.selectAll("path")
            .data(data.features)
            .enter()
            .append("path")
            .attr('fill-opacity', '0.5')
            .attr("z-index", "600")
            .attr("style", "pointer-events:all!important")
            .style("cursor", "pointer")
            .each(function (d) {
              regionList.map(function (c) {
                if (c.key === d.properties.REGION_UN) {
                  d.properties._projectCount = c.values.length;
                  d.properties._projectValue = d3.sum(c.values, function (d) {
                    return parseFloat(d["EUR Value of assignment"].toString().replace(/,/g, ''))
                  })
                  var filterValue = +(d.properties._projectCount);
                  domain[0] = filterValue < domain[0] ? filterValue :
                    domain[
                    0];
                  domain[1] = filterValue > domain[1] ? filterValue :
                    domain[
                    1];
                }
              });
            })
            .attr("stroke-width", "0.5px")
            .attr("stroke", "#848383")
            .attr("fill", function (d) {

              return d.properties._projectCount > (Math.ceil(_maxRegion / 4) * 3) ? '#006d2c' :
                d.properties._projectCount > (Math.ceil(_maxRegion / 4) * 2) ? '#41ab5d' :
                  d.properties._projectCount > (Math.ceil(_maxRegion / 4)) ? '#74c476' :
                    d.properties._projectCount > 0 ? '#a1d99b' :
                      '#fff';

            })
            .on("click", function (d) {
              //  console.log(filteredDataset);
              eventFire(document.getElementById('projectsButton'), 'click');

              var tableData = regionList.filter(function (k) {
                if (k.key === d.properties.REGION_UN) {
                  return k.values;
                }
              }).sort(function (a, b) {
                //  console.log(a);
                return a.gsize - b.gsize || a.glow - b.glow;
              });
              //  console.log(tableData);
              //  .sort(function(x, y) {
              //    return d3.ascending(x.COUNTRY, y.COUNTRY);
              //  });

              if (tableData[0]) {
                updateTable(tableData[0].values, "#projectsTable")
              } else {
                updateTable([], "#projectsTable")
              }

            })

          var array = ['#fff', '#a1d99b', '#74c476', '#41ab5d', '#006d2c'];
          var arrayLabel = ["No Projects", "0 - " + (Math.ceil(_maxRegion / 4)), (Math.ceil(_maxRegion / 4)) + " - " + (Math.ceil(_maxRegion / 4) * 2), (Math.ceil(_maxRegion / 4) * 2) + " - " + (Math.ceil(_maxRegion / 4) * 3), (Math.ceil(_maxRegion / 4) * 3) + " - " + (Math.ceil(_maxRegion / 4) * 4)];

          addLegend(array, arrayLabel, "Legend", "#legendRegion", "circle");

          mapRegions.on("moveend", updateRegions);

          updateRegions();

          function updateRegions() {
            featureElementRegions.attr("d", path);
          }
        }
      }
    });
  </script>

  <script>
    $("#regions").on('click', function () {
      $("#map").hide();
      $("#mapRegions").show();
      mapRegions.invalidateSize();

      var southWest = new L.LatLng(-62.406149313445724, -371.06284625024193),
        northEast = new L.LatLng(84.35856680726017, 431.65195637659485),
        bounds = new L.LatLngBounds(southWest, northEast);

      mapRegions.fitBounds(bounds);
    })
    $("#countries").on('click', function () {
      $("#map").show();
      $("#mapRegions").hide();
      map.invalidateSize();

      var southWest = new L.LatLng(-62.406149313445724, -371.06284625024193),
        northEast = new L.LatLng(84.35856680726017, 431.65195637659485),
        bounds = new L.LatLngBounds(southWest, northEast);

      map.fitBounds(bounds);
    })
  </script>

  <script src="src/pem.js"></script>
</body>

</html>